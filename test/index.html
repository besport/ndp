<!doctype html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>Mocha Spec Runner</title>
  <link rel="stylesheet" href="lib/mocha/mocha.css">
</head>
<body>
  <div id="mocha"></div>
  <script src="lib/mocha/mocha.js"></script>
  <script>mocha.setup('bdd')</script>
  <script src="lib/chai.js"></script>
  <script src="../date.js"></script>
      
  <script>
    expect = chai.expect

    chai.use (function (_chai, utils) {
      utils.overwriteMethod(chai.Assertion.prototype, 'equal', function (_super) {
        return function (d) {
          var obj = utils.flag(this, 'object');
          if (obj instanceof Date) {
            new chai.Assertion(obj.toString()).to.equal(d.toString());
            } else {
            _super.apply(this, arguments);
          }
        }
      });
    });

    // Start date is now
    var T = Date.Util.Interval;
    var start_date = new Date(new Date().getTime() - 4*T.Day);
    var start_time = start_date.getTime();

    // Simpler parse function
    var parse = function (s) { return Date.parse(s, start_date); };

    // Date objects relative to the start date
    var today      = new Date(start_time);
    var tomorrow   = new Date(start_time + T.Day);
    var yesterday  = new Date(start_time - T.Day);
    var next_year  = new Date(start_time); next_year.setYear(start_date.getFullYear()+1);
    var last_year  = new Date(start_time); last_year.setYear(start_date.getFullYear()-1);
    var next_month = new Date(start_time); next_month.setMonth(start_date.getMonth()+1);
    var last_month = new Date(start_time); last_month.setMonth(start_date.getMonth()-1);
    var next_week = new Date(start_time + T.Week);
    var last_week = new Date(start_time - T.Week);

    var next_weekend = new Date(start_time + (6-start_date.getDay())*T.Day);
    if (6 <= start_date.getDay()) next_weekend.setTime(next_weekend.getTime() + 7*T.Day);
    var last_weekend = new Date(start_time + (6-start_date.getDay())*T.Day);
    if (6 >= start_date.getDay()) last_weekend.setTime(last_weekend.getTime() - 7*T.Day);

    var next_monday_at_noon = new Date(start_time + (1-start_date.getDay())*T.Day);
    next_monday_at_noon.setHours(12);
    next_monday_at_noon.setMinutes(0);
    next_monday_at_noon.setSeconds(0);
    if (1 <= start_date.getDay()) next_monday_at_noon.setTime(next_monday_at_noon.getTime() + 7*T.Day);
  </script>

  <script>
  (function() {

    describe('Date parsing', function() {

      describe('Simple dates', function() {

        it('should parse "today"', function() {
          expect    (parse("today"))
          .to.equal (today);
        });

        it('should parse "tomorrow"', function() {
          expect    (parse("tomorrow"))
          .to.equal (tomorrow);
        });
        
        it('should parse "yesterday"', function() {
          expect    (parse("yesterday"))
          .to.equal (yesterday);
        });

      });

      describe('Simple times', function() {
        it('should parse "noon"', function() {
          expect   (parse("noon"))
          .to.satisfy (function(d) { return d.getHours() == 12 && d.getMinutes() == 0; });
        });

        it('should parse "midnight"', function() {
          expect   (parse("midnight"))
          .to.satisfy (function(d) { return d.getHours() == 0 && d.getMinutes() == 0; });
        });
      });

      describe('Next/Previous (Year, Month, Week)', function() {
        it('should parse "next year"', function() {
          expect    (parse("next year"))
          .to.equal (next_year);
        });

        it('should parse "last year"', function() {
          expect    (parse("last year"))
          .to.equal (last_year);
        });

        it('should parse "next month"', function() {
          expect    (parse("next month"))
          .to.equal (next_month);
        });

        it('should parse "last month"', function() {
          expect    (parse("last month"))
          .to.equal (last_month);
        });

        it('should parse "next week"', function() {
          expect    (parse("next week"))
          .to.equal (next_week);
        });

        it('should parse "last week"', function() {
          expect    (parse("last week"))
          .to.equal (last_week);
        });

        it('should parse "last weekend"', function() {
          expect    (parse("last weekend"))
          .to.equal (last_weekend);
        });

        it('should parse "next weekend"', function() {
          expect    (parse("next weekend"))
          .to.equal (next_weekend);
        });

        it('should parse "last week-end"', function() {
          expect    (parse("last week-end"))
          .to.equal (last_weekend);
        });

        it('should parse "next weekend"', function() {
          expect    (parse("next week-end"))
          .to.equal (next_weekend);
        });
      });

      describe ('Next/Previous (Day)', function() {

        // Create an expect rule for each day of the week, in full or abbrev form
        for (var day = 0; day < 7; day++) {
          var current_day = start_date.getDay();
          var next_date = new Date(start_time + (day-current_day)*T.Day); // Move to correct day
          if (day <= current_day) next_date.setTime(next_date.getTime() + 7*T.Day); // Add one week if necessary

          var expect_parse = function(n, d) {
            it('should parse "' + text_to_parse + '"', function() {
              expect (parse(n)).to.equal (d);
            });
          };

          var text_to_parse;

          text_to_parse = "next " + Date.Util.Day.Full[day];
          expect_parse (text_to_parse, next_date);

          text_to_parse = "next " + Date.Util.Day.Abbrev[day];
          expect_parse (text_to_parse, next_date);

          text_to_parse = Date.Util.Day.Full[day];
          expect_parse (text_to_parse, next_date);

          text_to_parse = Date.Util.Day.Abbrev[day];
          expect_parse (text_to_parse, next_date);
        }
      });

      describe ('Time expressions', function() {
        it('should parse 24-hour format times', function() {
          expect (parse("today at 17:32")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 32 && d.getHours() == 17;
          });
        });

        it('should parse 12-hour format times (PM)', function() {
          expect (parse("tomorrow at 7:32PM")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 32 && d.getHours() == 19;
          }, parse("tomorrow at 7:32PM").toString());

          expect (parse("tomorrow at 7:32 PM")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 32 && d.getHours() == 19;
          }, parse("tomorrow at 7:32 PM").toString());

          expect (parse("tomorrow at 7 PM")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 0 && d.getHours() == 19;
          }, parse("tomorrow at 7 PM").toString());
        });

        it('should parse 12-hour format times (AM)', function() {
          expect (parse("yesterday at 7:32AM")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 32 && d.getHours() == 7;
          });

          expect (parse("yesterday at 7:32 AM")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 32 && d.getHours() == 7;
          });

          expect (parse("yesterday at 7 h")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 0 && d.getHours() == 7;
          });

          expect (parse("yesterday at 7hr")).to.satisfy (function (d) {
            return d.getMonth() == start_date.getMonth() && d.getFullYear() == start_date.getFullYear() &&
                   d.getMinutes() == 0 && d.getHours() == 7;
          });
        });
      });

      describe ('Date expressions', function() {
        it('should parse "4/16/2015"', function() {
          expect      (parse("4/16/2015"))
          .to.satisfy (function(d) { return d.getDate() == 16 && d.getMonth() == 3 && d.getFullYear() == 2015; });
        });

        it('should parse "4.16.2015"', function() {
          expect      (parse("4.16.2015"))
          .to.satisfy (function(d) { return d.getDate() == 16 && d.getMonth() == 3 && d.getFullYear() == 2015; });
        });

        it('should parse "October 13"', function() {
          expect      (parse("October 13"))
          .to.satisfy (function(d) { return d.getDate() == 13 && d.getMonth() == 9; });
        });

        it('should parse "Monday, October 13"', function() {
          expect      (parse("Monday, October 13"))
          .to.satisfy (function(d) { return d.getDate() == 13 && d.getMonth() == 9; });
        });

        it('should parse "October 13, 2015"', function() {
          expect      (parse("October 13, 2015"))
          .to.satisfy (function(d) { return d.getDate() == 13 && d.getMonth() == 9 && d.getFullYear() == 2015; });
        });

        it('should parse "Monday, October 13, 2015"', function() {
          expect      (parse("Monday, October 13, 2015"))
          .to.satisfy (function(d) { return d.getDate() == 13 && d.getMonth() == 9 && d.getFullYear() == 2015; });
        });
      });

      describe ('Other sample tests', function() {
        it('should parse "We\'re going to make a big tennis game next monday at noon, who\'s coming?"', function() {
          expect    (parse("We're going to make a big tennis game next monday at noon, who's coming?"))
          .to.equal (next_monday_at_noon);
        });

        it('should parse "Let\'s have lunch next monday!"', function() {
          expect    (parse("Let's have lunch next monday!"))
          .to.equal (next_monday_at_noon);
        });
      });
    });
  })();
  </script>

  <!-- trigger the mocha runner -->
  <script src="runner/mocha.js"></script>

</body>
</html>
